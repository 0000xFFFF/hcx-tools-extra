#!/usr/bin/env python3

import sys
import subprocess
import argparse
from utils import parse_hash_line, read_lines_from_file


def parse_arguments():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description='Generate password.csv for hcx-wifi from cracked hashes'
    )
    parser.add_argument('hashes', help='Path to hashes input file')
    return parser.parse_args()


def get_cracked_passwords(hashes_file_path):
    """Run hashcat --show and return a dictionary of hash_id to password."""
    hashcat_items = {}
    try:
        result = subprocess.run(
            ['hashcat', '-m', '22000', '--show', hashes_file_path],
            stdout=subprocess.PIPE, 
            stderr=subprocess.STDOUT, 
            text=True
        )
        for line in result.stdout.splitlines():
            if not line:
                continue
            clms = line.split(":")
            if len(clms) >= 5:
                hashcat_items[clms[0]] = clms[4]
    except subprocess.SubprocessError as e:
        print(f"Error running hashcat: {e}", file=sys.stderr)
        sys.exit(1)
    
    return hashcat_items


def format_bssid(bssid):
    """Format BSSID to uppercase."""
    return bssid.upper()


def generate_wifi_password_list(lines, cracked_passwords):
    """Generate WiFi password list in CSV format."""
    results = []
    
    for line in lines:
        if not line:
            continue
        
        parsed = parse_hash_line(line)
        if not parsed:
            print("Invalid format", file=sys.stderr)
            continue
        
        bssid = format_bssid(parsed['bssid'])
        essid = parsed['essid']
        passwd = cracked_passwords.get(parsed['hash'], "...")
        
        results.append(f"{bssid}|||{essid}|||{passwd}")
    
    return results


def main():
    """Main execution function."""
    args = parse_arguments()
    
    # Read hash file
    lines = read_lines_from_file(args.hashes)
    
    # Get cracked passwords from hashcat
    cracked_passwords = get_cracked_passwords(args.hashes)
    
    # Generate and print password list
    password_list = generate_wifi_password_list(lines, cracked_passwords)
    
    for entry in password_list:
        print(entry)


if __name__ == "__main__":
    main()

