#!/usr/bin/env python3

import argparse
from utils import parse_hash_line, read_lines_from_file, get_unique_key


def parse_arguments():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description='Remove hashes from another file by matching BSSID+ESSID'
    )
    parser.add_argument('hashes', help='Path to hashes input file')
    parser.add_argument('remove', help='Path to hashes to remove file')
    return parser.parse_args()


def build_removal_set(lines):
    """Build a set of keys to remove from the removal file."""
    keys_to_remove = set()
    
    for line in lines:
        if not line:
            continue
        
        parsed = parse_hash_line(line)
        if not parsed:
            continue
        
        key = get_unique_key(parsed)
        keys_to_remove.add(key)
    
    return keys_to_remove


def filter_hashes(lines, keys_to_remove):
    """Filter out hashes that match keys in the removal set."""
    filtered_lines = []
    
    for line in lines:
        if not line:
            continue
        
        parsed = parse_hash_line(line)
        if not parsed:
            continue
        
        key = get_unique_key(parsed)
        if key not in keys_to_remove:
            filtered_lines.append(line)
    
    return filtered_lines


def main():
    """Main execution function."""
    args = parse_arguments()
    
    # Read both files
    main_lines = read_lines_from_file(args.hashes)
    remove_lines = read_lines_from_file(args.remove)
    
    # Build removal set
    keys_to_remove = build_removal_set(remove_lines)
    
    # Filter and print remaining hashes
    filtered_hashes = filter_hashes(main_lines, keys_to_remove)
    
    for line in filtered_hashes:
        print(line)


if __name__ == "__main__":
    main()

